# Prompt ç®¡ç†ç³»ç»Ÿ - æ¶æ„è®¾è®¡

> **ç›¸å…³æ–‡æ¡£**ï¼š[v2.0.0 å‡çº§è®¡åˆ’](./prompt-management-plan.md)

---

## ğŸ—ï¸ æ¶æ„æ¦‚è§ˆ

### è®¾è®¡åŸåˆ™

1. **å•ä¸€æ•°æ®æº**ï¼ˆSingle Source of Truthï¼‰
2. **ç»Ÿä¸€æ¥å£**ï¼ˆUnified APIï¼‰
3. **ä¸‰çº§ä¼˜å…ˆçº§**ï¼ˆThree-tier Priorityï¼‰
4. **æœåŠ¡è§£è€¦**ï¼ˆService Decouplingï¼‰

### ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Client Request                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼               â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Codex      â”‚ â”‚ Claude Code  â”‚ â”‚    Droid     â”‚
â”‚   Routes     â”‚ â”‚  Converter   â”‚ â”‚   Relay      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                â”‚                â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Three-tier Logic â”‚
              â”‚   P1: User       â”‚
              â”‚   P2: Default    â”‚
              â”‚   P3: Disabled   â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â–¼               â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Config   â”‚  â”‚  Prompt    â”‚  â”‚   Cache    â”‚
â”‚   System   â”‚  â”‚  Loader    â”‚  â”‚   Layer    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ resources/      â”‚
              â”‚   prompts/      â”‚
              â”‚   â”œâ”€ codex.txt  â”‚
              â”‚   â”œâ”€ claude.txt â”‚
              â”‚   â””â”€ droid.txt  â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¦ æ ¸å¿ƒç»„ä»¶

### 1. Prompt Loaderï¼ˆpromptLoader.jsï¼‰

**èŒè´£**ï¼š
- å¯åŠ¨æ—¶åŠ è½½æ‰€æœ‰ prompt æ–‡ä»¶
- æä¾›ç»Ÿä¸€çš„ prompt æ£€ç´¢ API
- ç¼“å­˜ prompt å†…å®¹åˆ°å†…å­˜
- æ”¯æŒçƒ­é‡è½½ï¼ˆæœªæ¥ï¼‰

**API**ï¼š
```javascript
class PromptLoader {
  async initialize()              // åˆå§‹åŒ–åŠ è½½
  getPrompt(service)              // è·å– prompt
  async reload()                  // é‡æ–°åŠ è½½ï¼ˆçƒ­é‡è½½ï¼‰
  getHealthStatus()               // å¥åº·çŠ¶æ€
}
```

**æ€§èƒ½ç›®æ ‡**ï¼š
- åˆå§‹åŒ–æ—¶é—´ï¼š<20ms
- prompt æ£€ç´¢ï¼š<1ms
- å†…å­˜å ç”¨ï¼š<100KB

### 2. Resources ç›®å½•ï¼ˆresources/prompts/ï¼‰

**ç»“æ„**ï¼š
```
resources/prompts/
â”œâ”€â”€ codex.txt          # ~24KB
â”œâ”€â”€ claude-code.txt    # ~57 chars
â”œâ”€â”€ droid.txt          # ~65 chars
â””â”€â”€ README.md          # ä½¿ç”¨è¯´æ˜
```

**è®¾è®¡å†³ç­–**ï¼š
- æ‰€æœ‰ prompts ä½¿ç”¨å¤–éƒ¨æ–‡ä»¶ï¼ˆç»Ÿä¸€æ¶æ„ï¼‰
- UTF-8 ç¼–ç 
- æ— éœ€ç‰¹æ®Šæ ¼å¼ï¼ˆçº¯æ–‡æœ¬ï¼‰
- æ”¯æŒå¤šè¡Œå’Œç‰¹æ®Šå­—ç¬¦

### 3. é…ç½®ç³»ç»Ÿï¼ˆconfig.promptsï¼‰

**é…ç½®å—**ï¼š
```javascript
prompts: {
  codex: { enabled: true },
  claudeCode: { enabled: true },
  droid: { enabled: true }
}
```

**ç¯å¢ƒå˜é‡**ï¼š
```bash
CODEX_PROMPT_ENABLED=true
CLAUDE_CODE_PROMPT_ENABLED=true
DROID_PROMPT_ENABLED=true
```

---

## ğŸ”„ ä¸‰çº§ä¼˜å…ˆçº§ç³»ç»Ÿ

### ä¼˜å…ˆçº§é€»è¾‘

```javascript
function getSystemPrompt(userMessage, service, config) {
  // P1: ç”¨æˆ·è‡ªå®šä¹‰ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
  if (userMessage) {
    return userMessage
  }

  // P2: é…ç½®é»˜è®¤
  if (config.prompts[service].enabled) {
    return promptLoader.getPrompt(service)
  }

  // P3: æ— æ³¨å…¥ï¼ˆé…ç½®ç¦ç”¨ï¼‰
  return null
}
```

### ä¼˜å…ˆçº§è¡¨

| ä¼˜å…ˆçº§ | è§¦å‘æ¡ä»¶ | è¿”å›å€¼ |
|--------|----------|--------|
| **P1** | ç”¨æˆ·æä¾› system message | ç”¨æˆ·å†…å®¹ |
| **P2** | æ— ç”¨æˆ· message + é…ç½®å¯ç”¨ | é»˜è®¤ prompt |
| **P3** | é…ç½®ç¦ç”¨ | nullï¼ˆä¸æ³¨å…¥ï¼‰ |

### æœåŠ¡ç‰¹å®šå®ç°

**Codex**ï¼š
- P1 æ¥æºï¼š`req.body.instructions`
- P2 æ³¨å…¥ï¼šæ›¿æ¢ `req.body.instructions`

**Claude Code**ï¼š
- P1 æ¥æºï¼šæå–è‡ª `messages` ä¸­çš„ `system` role
- P2 æ³¨å…¥ï¼šè®¾ç½® `claudeRequest.system`

**Droid**ï¼š
- Anthropic ç«¯ç‚¹ï¼šå‰ç½®æ³¨å…¥åˆ° `processedBody.system` æ•°ç»„
- OpenAI ç«¯ç‚¹ï¼šå‰ç½®æ³¨å…¥åˆ° `processedBody.instructions`

**âš ï¸ Droid ç‰¹æ®Šè¡Œä¸º**ï¼š

Droid æœåŠ¡ä¿æŒ**å‰ç½®æ³¨å…¥æ¨¡å¼**ï¼ˆå‚è§å†³ç­– 3: Droid ä¿æŒå‰ç½®æ³¨å…¥ï¼‰ï¼Œè¡Œä¸ºä¸ Codex/Claude Code ä¸åŒï¼š
- **P2**: `config.prompts.droid.enabled` â†’ å‰ç½®æ³¨å…¥ Droid promptï¼ˆéè¦†ç›–ï¼‰
- **P3**: é…ç½®ç¦ç”¨ â†’ ä¸æ³¨å…¥
- **æ—  P1 ä¼˜å…ˆçº§**ï¼šä¸æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æä¾›è‡ªå®šä¹‰ system/instructions

è¿™æ„å‘³ç€å½“é…ç½®å¯ç”¨æ—¶ï¼ŒDroid prompt ä¼šè¢«æ·»åŠ åˆ°ç”¨æˆ·å†…å®¹**å‰é¢**ï¼Œå³ä½¿ç”¨æˆ·å·²æä¾›è‡ªå®šä¹‰ system messageã€‚æ­¤è®¾è®¡æ˜¯ä¸ºäº†ä¿æŒå‘åå…¼å®¹æ€§ã€‚

---

## ğŸ”Œ æœåŠ¡é›†æˆ

### Codex é›†æˆ

**ä½ç½®**ï¼š`src/routes/openaiRoutes.js`

**æ”¹é€ ç‚¹**ï¼š
- ç§»é™¤ç¬¬ 282-284 è¡Œçš„ç¡¬ç¼–ç 
- å®ç°ä¸‰çº§ä¼˜å…ˆçº§é€»è¾‘
- ä¿ç•™å­—æ®µæ¸…ç†é€»è¾‘ï¼ˆ`fieldsToRemove`ï¼‰

### Claude Code é›†æˆ

**ä½ç½®**ï¼š`src/services/openaiToClaude.js`

**æ”¹é€ ç‚¹**ï¼š
- ç§»é™¤ Xcode æ£€æµ‹é€»è¾‘ï¼ˆç¬¬ 39-52 è¡Œï¼‰
- å®ç°ä¸‰çº§ä¼˜å…ˆçº§é€»è¾‘
- ç®€åŒ–ä»£ç ï¼ˆä» 19 è¡Œå‡å°‘åˆ° 13 è¡Œï¼‰

### Droid é›†æˆ

**ä½ç½®**ï¼š`src/services/droidRelayService.js`

**æ”¹é€ ç‚¹**ï¼š
- åˆ é™¤ SYSTEM_PROMPT å¸¸é‡ï¼ˆç¬¬ 12ã€29 è¡Œï¼‰
- æ”¹é€  `_processRequestBody` æ–¹æ³•
- ä¿æŒå‰ç½®æ³¨å…¥è¡Œä¸ºï¼ˆå…¼å®¹æ€§ï¼‰

---

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### ç¼“å­˜ç­–ç•¥

**å¯åŠ¨æ—¶åŠ è½½**ï¼š
- æ‰€æœ‰ prompts ä¸€æ¬¡æ€§åŠ è½½åˆ°å†…å­˜
- é¿å…æ¯æ¬¡è¯·æ±‚è¯»å–æ–‡ä»¶

**å†…å­˜å ç”¨**ï¼š
```
codex:      ~24KB
claude:     ~57 bytes
droid:      ~65 bytes
overhead:   ~1KB (å¯¹è±¡ç»“æ„)
--------------------------
Total:      ~25KB
```

### æ£€ç´¢æ€§èƒ½

**ä¼˜åŒ–æªæ–½**ï¼š
- ä½¿ç”¨å¯¹è±¡å±æ€§ç›´æ¥è®¿é—®ï¼ˆO(1)ï¼‰
- æ— éœ€æ–‡ä»¶ I/O
- æ— éœ€è§£ææˆ–è½¬æ¢

**åŸºå‡†æµ‹è¯•**ï¼š
```javascript
// é¢„æœŸæ€§èƒ½
getPrompt('codex')      // <1ms
getPrompt('claudeCode') // <1ms
getPrompt('droid')      // <1ms
```

---

## ğŸ” å®‰å…¨è€ƒè™‘

### æ–‡ä»¶è®¿é—®å®‰å…¨

- åªè¯»å– `resources/prompts/` ç›®å½•
- éªŒè¯ service åç§°ï¼ˆé˜²æ­¢è·¯å¾„éå†ï¼‰
- ä½¿ç”¨ `path.join` æ„å»ºè·¯å¾„

### è¾“å…¥éªŒè¯

**promptLoader.getPrompt(service)**ï¼š
```javascript
const validServices = ['codex', 'claudeCode', 'droid']
if (!validServices.includes(service)) {
  return null
}
```

### Web API å®‰å…¨

- éœ€è¦ç®¡ç†å‘˜è®¤è¯ï¼ˆ`authenticateAdmin`ï¼‰
- éªŒè¯ service å‚æ•°ï¼ˆç™½åå•ï¼‰
- éªŒè¯ content ç±»å‹ï¼ˆå¿…é¡»æ˜¯å­—ç¬¦ä¸²ï¼‰
- éªŒè¯ content éç©º
- éªŒè¯ content å¤§å°ï¼ˆæœ€å¤§ 1MBï¼‰
- éªŒè¯ Unicode å†…å®¹ï¼ˆç¦æ­¢æ§åˆ¶å­—ç¬¦ã€é›¶å®½å­—ç¬¦ã€æ–¹å‘æ§åˆ¶ç¬¦å¦‚ RTL overrideï¼‰
- æ–‡ä»¶å†™å…¥ä½¿ç”¨åŒæ­¥æ“ä½œï¼ˆåŸå­æ€§ï¼‰

---

## ğŸ§ª å¯æµ‹è¯•æ€§

### å•å…ƒæµ‹è¯•ç‚¹

1. **promptLoader åˆå§‹åŒ–**
   - æ–‡ä»¶å­˜åœ¨æ—¶æˆåŠŸåŠ è½½
   - æ–‡ä»¶ç¼ºå¤±æ—¶æŠ›å‡ºå¼‚å¸¸ï¼ˆfail fastï¼‰
   - æ–‡ä»¶è¯»å–å¤±è´¥æ—¶æŠ›å‡ºå¼‚å¸¸

2. **prompt æ£€ç´¢**
   - æœ‰æ•ˆ service è¿”å›å†…å®¹
   - æ— æ•ˆ service è¿”å› null

3. **å¥åº·çŠ¶æ€**
   - æŠ¥å‘Šæ­£ç¡®çš„åŠ è½½çŠ¶æ€
   - æ˜¾ç¤ºæ¯ä¸ª prompt çš„å¯ç”¨æ€§

### é›†æˆæµ‹è¯•ç‚¹

1. **ä¸‰çº§ä¼˜å…ˆçº§**
   - P1: ç”¨æˆ·è‡ªå®šä¹‰ç”Ÿæ•ˆ
   - P2: é»˜è®¤ prompt ç”Ÿæ•ˆ
   - P3: é…ç½®ç¦ç”¨ç”Ÿæ•ˆ

2. **æœåŠ¡ç«¯åˆ°ç«¯**
   - Codex å®Œæ•´æµç¨‹
   - Claude Code å®Œæ•´æµç¨‹
   - Droid å®Œæ•´æµç¨‹

---

## ğŸ“Š ç›‘æ§æŒ‡æ ‡

### ç³»ç»ŸæŒ‡æ ‡

```javascript
{
  "promptLoader": {
    "loaded": true,
    "prompts": {
      "codex": { "available": true, "length": 23831 },
      "claudeCode": { "available": true, "length": 57 },
      "droid": { "available": true, "length": 65 }
    }
  }
}
```

---

## ğŸš€ å®Œæ•´åŠŸèƒ½å®ç°ï¼ˆv2.0.0ï¼‰

### çƒ­é‡è½½æ”¯æŒ

promptLoader æä¾› `reload()` æ–¹æ³•ï¼Œæ‰€æœ‰ Web API ä¿®æ”¹æ“ä½œï¼ˆæ‰‹åŠ¨ç¼–è¾‘ã€æ–‡ä»¶ä¸Šä¼ ã€URL å¯¼å…¥ï¼‰ä¼šè‡ªåŠ¨è§¦å‘çƒ­é‡è½½ï¼š

```javascript
class PromptLoader {
  async reload() {
    logger.info('ğŸ”„ Reloading all prompts...')
    this.loaded = false
    await this.initialize()
  }
}
```

**è°ƒç”¨æ—¶æœº**ï¼š
- PUT /admin/prompts/:serviceï¼ˆæ‰‹åŠ¨ç¼–è¾‘ä¿å­˜åï¼‰
- POST /admin/prompts/:service/uploadï¼ˆæ–‡ä»¶ä¸Šä¼ åï¼‰
- POST /admin/prompts/:service/import-urlï¼ˆURL å¯¼å…¥åï¼‰

### è¿œç¨‹æºå¯¼å…¥

Web API æä¾›ä» HTTPS URL å¯¼å…¥ prompt åŠŸèƒ½ï¼š

```javascript
POST /admin/prompts/:service/import-url
{
  "url": "https://example.com/prompts/codex-latest.txt",
  "validate": true  // é¢„è§ˆæ¨¡å¼ï¼Œè¿”å›å†…å®¹ä½†ä¸ä¿å­˜
}
```

**å®‰å…¨é™åˆ¶**ï¼š
- ä»…æ”¯æŒ HTTPS åè®®
- 1MB å¤§å°é™åˆ¶
- å®Œæ•´çš„ Unicode éªŒè¯
- ç®¡ç†å‘˜è®¤è¯

### æ–‡ä»¶ä¸Šä¼ 

Web API æ”¯æŒç›´æ¥ä¸Šä¼  .txt æ–‡ä»¶ï¼ˆé€‚åˆå¤§å‹ promptï¼‰ï¼š

```javascript
POST /admin/prompts/:service/upload
Content-Type: multipart/form-data
file: [promptæ–‡ä»¶]
```

**ä¼˜åŠ¿**ï¼š
- é¿å…æ‰‹åŠ¨å¤åˆ¶ç²˜è´´ 24KB å†…å®¹
- æ”¯æŒä»»æ„æ–‡æœ¬ç¼–è¾‘å™¨ç¼–è¾‘åä¸Šä¼ 
- ä¸æ‰‹åŠ¨ç¼–è¾‘ä½¿ç”¨ç›¸åŒçš„éªŒè¯é€»è¾‘

---

## ğŸ“ è®¾è®¡å†³ç­–è®°å½•

### å†³ç­– 1: å° prompt ä¹Ÿä½¿ç”¨å¤–éƒ¨æ–‡ä»¶

**èƒŒæ™¯**ï¼šClaude Code å’Œ Droid çš„ prompt åªæœ‰ 57/65 å­—ç¬¦

**é€‰é¡¹**ï¼š
- A. ä½¿ç”¨é…ç½®å¸¸é‡
- B. ä½¿ç”¨å¤–éƒ¨æ–‡ä»¶

**å†³ç­–**ï¼šBï¼ˆç»Ÿä¸€æ¶æ„ï¼‰

**ç†ç”±**ï¼š
- Web ç¼–è¾‘æ˜¯ v2.0.0 æ ¸å¿ƒåŠŸèƒ½
- æ¶æ„ä¸€è‡´æ€§ä¼˜äºä»£ç ç®€æ´æ€§
- ç”¨æˆ·å¯èƒ½ä¿®æ”¹ä¸ºæ›´é•¿å†…å®¹

### å†³ç­– 2: ç§»é™¤ Xcode ç‰¹æ®Šæ£€æµ‹

**èƒŒæ™¯**ï¼šopenaiToClaude.js æœ‰ Xcode æ ¼å¼ç‰¹æ®Šå¤„ç†

**é€‰é¡¹**ï¼š
- A. ä¿ç•™ Xcode æ£€æµ‹
- B. ç§»é™¤ï¼Œä½¿ç”¨ä¸‰çº§ä¼˜å…ˆçº§

**å†³ç­–**ï¼šBï¼ˆç®€åŒ–ä»£ç ï¼‰

**ç†ç”±**ï¼š
- P1 è‡ªåŠ¨æ•è· Xcode è¯·æ±‚
- è¡Œä¸ºç»“æœå®Œå…¨ç›¸åŒ
- ä»£ç æ›´ç®€æ´é€šç”¨

### å†³ç­– 3: Droid ä¿æŒå‰ç½®æ³¨å…¥

**èƒŒæ™¯**ï¼šDroid ç°åœ¨æ˜¯å‰ç½®æ³¨å…¥ï¼Œä¸æ˜¯è¦†ç›–

**é€‰é¡¹**ï¼š
- A. æ”¹ä¸ºè¦†ç›–ï¼ˆP2 ä¼˜å…ˆï¼‰
- B. ä¿æŒå‰ç½®ï¼ˆå…¼å®¹æ€§ï¼‰

**å†³ç­–**ï¼šBï¼ˆå‘åå…¼å®¹ï¼‰

**ç†ç”±**ï¼š
- ç°æœ‰è¡Œä¸ºå·²ç¨³å®š
- ä¸å½±å“ç”¨æˆ·ä½“éªŒ
- é¿å…ç ´åæ€§å˜æ›´

---

## âœ… æ¶æ„éªŒè¯æ¸…å•

- [ ] å•ä¸€æ•°æ®æºï¼ˆæ‰€æœ‰ prompts åœ¨ resources/prompts/ï¼‰
- [ ] ç»Ÿä¸€æ¥å£ï¼ˆæ‰€æœ‰æœåŠ¡ä½¿ç”¨ promptLoaderï¼‰
- [ ] ä¸‰çº§ä¼˜å…ˆçº§ï¼ˆP1 > P2 > P3 æ­£ç¡®å®ç°ï¼‰
- [ ] æœåŠ¡è§£è€¦ï¼ˆpromptLoader ç‹¬ç«‹äºä¸šåŠ¡é€»è¾‘ï¼‰
- [ ] æ€§èƒ½è¾¾æ ‡ï¼ˆæ£€ç´¢ <1msï¼Œå†…å­˜ <100KBï¼‰
- [ ] å¯æµ‹è¯•æ€§ï¼ˆå•å…ƒæµ‹è¯• + é›†æˆæµ‹è¯•è¦†ç›–ï¼‰
- [ ] å¯æ‰©å±•æ€§ï¼ˆçƒ­é‡è½½ã€è¿œç¨‹æºæ¶æ„é¢„ç•™ï¼‰
